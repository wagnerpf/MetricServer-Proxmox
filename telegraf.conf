# Telegraf Configuration for Proxmox VE Monitoring
[global_tags]
  environment = "production"
  datacenter = "proxmox-lab"

[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  debug = false
  quiet = false
  hostname = "telegraf-proxmox"
  omit_hostname = false

# ============================================================================
# OUTPUTS - Enviar métricas para InfluxDB
# ============================================================================

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUXDB_TOKEN}"
  organization = "proxmox-org"
  bucket = "proxmox-metrics"
  timeout = "20s"

# ============================================================================
# INPUTS - Fontes de métricas
# ============================================================================

# 1. Prometheus/Proxmox Metrics API (via HTTP)
[[inputs.prometheus]]
  urls = ["http://${PROXMOX_HOST}:8007/api2/json/nodes"]
  interval = "60s"
  # Configuração de autenticação com Proxmox
  [inputs.prometheus.headers]
    Authorization = "PVEAPIToken=${PROXMOX_TOKEN}"

# 2. Coletar métricas via SNMP (se habilitado no Proxmox)
# Descomente se quiser usar SNMP
# [[inputs.snmp]]
#   agents = ["${PROXMOX_HOST}:161"]
#   community = "${SNMP_COMMUNITY}"
#   interval = "60s"
#   version = 2

# 3. Coletar métricas do host local (Node Exporter format)
[[inputs.prometheus]]
  urls = ["http://node-exporter:9100/metrics"]
  interval = "60s"
  metric_version = 2

# 4. Health check do sistema
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false
  interval = "60s"

[[inputs.mem]]
  interval = "60s"

[[inputs.disk]]
  interval = "60s"
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

[[inputs.diskio]]
  interval = "60s"

[[inputs.net]]
  interval = "60s"

[[inputs.netstat]]
  interval = "60s"

# 5. Logs do Docker (opcional)
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  interval = "60s"
  # Remova o comentário para habilitar
  # gather_services = false
  # timeout = "5s"

# 6. HTTP Health Check para Proxmox API
[[inputs.http_response]]
  address = "https://${PROXMOX_HOST}:8006/api2/json/version"
  method = "GET"
  timeout = "10s"
  interval = "60s"
  insecure_skip_verify = true
  [inputs.http_response.headers]
    Authorization = "PVEAPIToken=${PROXMOX_TOKEN}"

# 7. Monitoramento de Processos
[[inputs.processes]]
  interval = "60s"

[[inputs.system]]
  interval = "60s"

# ============================================================================
# PROCESSAMENTO DE DADOS (Opcional)
# ============================================================================

# Adicionar tags customizadas
[[processors.tags]]
  [processors.tags.tags]
    service = "proxmox-monitoring"
    stack = "docker-compose"

# Remover campos desnecessários
[[processors.fields]]
  drop = ["uptime_format"]
